\section{Appendices}

\subsection{Theorem~\ref{thm:traj-refines}}

We use freely the fact that $[\{ c \}] = [c]$ and first prove a few lemmas.

\begin{lemma} \label{lem:class-sub}
$[d] \cap \Antecedent(\rho) \neq \emptyset \implies [d] \subseteq \Antecedent(\rho)$
\end{lemma}

Since they intersect, there must exist $d' \in [d]$ such that $d' \in \Antecedent(\rho)$. By the invariance of $\Antecedent(\rho)$, it must be that $[d'] = [d] \subseteq \Antecedent(\rho)$. $\qedbox$

\begin{lemma} \label{lem:traj-con}
$d \in \Consequent(\rho) \wedge \{ c \} \ll \{ d \} \implies c \in \gamma(\Consequent(\rho))$
\end{lemma}

By the invariance of $\Consequent$, $d \in \Consequent(\rho)$ implies that $[d] \subseteq \Consequent(\rho)$, which in turn implies $\gamma([d]) \subseteq \gamma(\Consequent(\rho))$ by the monotonicity of $\gamma$. By definition of $\{ c \} \ll \{ d \}$, we know $[c] \subseteq \gamma([d])$, and thus $[c] \subseteq \gamma(\Consequent(\rho))$. That $c \in \gamma(\Consequent(\rho))$ then follows. $\qedbox$

\begin{lemma} \label{lem:traj-ant}
$c \in \gamma(\Antecedent(\rho)) \wedge \{ c \} \ll \{ d \} \implies d \in \Antecedent(\rho)$
\end{lemma}

By the invariance of $\Antecedent$, and the preservation of it by $\gamma$, $c \in \gamma(\Antecedent(\rho))$ implies that $[c] \subseteq \gamma(\Antecedent(\rho))$. And thus $\alpha([c]) \subseteq \alpha(\gamma(\Antecedent(\rho)) \subseteq \Antecedent(\rho)$ by the monotonicity of $\alpha$. By definition of $\{ c \} \ll \{ d \}$, we also have that $\alpha([c]) \subseteq [d]$. Since $\alpha([c]) \neq \emptyset$, it must be that $[d] \cap \Antecedent(\rho) \neq \emptyset$, and thus $[d] \subseteq \Antecedent(\rho)$ by lemma~\ref{lem:class-sub}. That $d \in \Antecedent(\rho)$ then follows immediately. $\qedbox$
\\

For the theorem, we are given $\tau \in \Traj(M)$ and $\rho \in \Runs(\gamma(A))$, such that $| \tau | = | \rho |$ and $\tau_{n} \in \gamma(\Antecedent(\rho_{n}))$ for all $n \in \mathbb{N} : n < | \tau |$. We must then show that $\tau_{n} \in \gamma(\Consequent(\rho_{n}))$. By the refinement assumption, there must exist a $\upsilon \in \Traj(N)$ such that $| \tau | = | \upsilon | = | \rho |$ and $\{ \tau_{n} \} \ll \{ \upsilon_{n} \}$. Lemma~\ref{lem:traj-ant} then shows that $\upsilon_{n} \in \Antecedent(\rho_{n})$ and, by the assumption, we have $\upsilon_{n} \in \Consequent(\rho_{n})$. Lemma~\ref{lem:traj-con} then shows that $\tau_{n} \in \gamma(\Consequent(\rho_{n}))$. $\qedbox$

\subsection{Theorem~\ref{thm:traj-equal-set}}

We first show a lemma.

\begin{lemma} \label{lem:ll-sub}
$C \ll D \wedge D \subseteq D' \implies C \ll D'$
\end{lemma}

That $C$ is approximated by $D'$ follows immediately: $\alpha(C) \subseteq D \subseteq D'$. The first property of $\ll$ follows from the definition of subset, and the second by the monotonicity of $N$: $\alpha(M(C)) \subseteq N(D) \subseteq N(D')$. $\qedbox$
\\

We prove each direction of the theorem separately.

$(\Rightarrow)$ : If $C \ll D$, then by definition $\alpha([C]) \subseteq [D]$. As $\alpha$ distributes over arbitrary union, it follows that $\alpha([c]) \subseteq [D]$ for all $c \in C$. We note that every such $c \in C$ is also the start of some trajectories in $M$, and it therefore follows from the refinement assumption that there exist a trajectory in $N$ with a start $d \in \sD$ such that $\{ c \} \ll \{ d \}$, or $\alpha([c]) \subseteq [d]$. By the requirement that $\alpha([c]) \neq \emptyset$, it must be that $[d] \cap [D] \neq \emptyset$. By lemma~\ref{lem:class-sub} then, we know $[d] \subseteq [D]$ and thus $d \in D$, which is the first property required of $\ll$. For the second property, that $\ll$ is a simulation relation, consider any ``next-step'' of these trajectories starting in $c$ and $d$, i.e. $c' \in M(\{ c \})$ and $d' \in N(\{ d \})$. From the refinement assumption we know that $\{ c' \} \ll \{ d' \}$, or $\alpha([c']) \subseteq [d'] \subseteq [N(\{ d \})] \subseteq [N(D)]$. Taking the union of every such ordering for $c' \in M(\{ c \})$, we see that $M(\{ c \}) \ll N(D)$ for all $c \in C$, or $M(C) \ll N(D)$, as required.

% there exists a $d' \in N(D)$ such that $\{ c' \} \ll \{ d' \}$, which implies that $\{ c' \} \ll N(D)$ by lemma~\ref{lem:ll-sub}. Combining all such orderings, we have the desired $M(C) \ll N(D)$. $\qedbox$

% i.e. $\alpha([C]) = \cup \{ \alpha([c]) \in \pow(\C) \mid c \in C \}$

$(\Leftarrow)$ : We show this claim by induction on the length of $\tau$. For the base case, $| \tau | = 1$, we are given $\tau = \langle \tau_{1} \rangle$ where $\tau_{1}$ is unconstrained, i.e. we only know that $\tau_{1} \in \sC$. But a Galois connection always relates the most general states of its two partially ordered sets, so $\alpha(\{ \sC \}) \subseteq \{ \sD \}$. As $[\{ \sC \}] = \{ \sC \}$ and $[\{ \sD \}] = \{ \sD \}$, we also have $\alpha([\{ \sC \}]) \subseteq [\{ \sD \}]$, or $\{ \sC \} \ll \{ \sD \}$. Using the first property of $\ll$ then tells us that there exists $d \in \sD$ such that $|\langle \tau_{1} \rangle| = |\langle d \rangle|$ and $\{ \tau_{1} \} \ll \{ d \}$. For the inductive step, $| \tau | = n + 1$, we are given a sequence $\langle \dots, \tau_{n}, \tau_{n+1} \rangle$ and assume there exists another sequence $\langle \dots, \upsilon_{n} \rangle$ such that $|\langle \dots, \tau_{n} \rangle| = |\langle \dots, \upsilon_{n} \rangle|$ and $\langle \dots, \tau_{n} \rangle \ll \langle \dots, \upsilon_{n} \rangle$. From the simulation property of $\ll$, we know that $M(\tau_{n}) \ll N(\upsilon_{n})$ and, by the definition of trajectories, that $\tau_{n+1} \in M(\tau_{n})$. Applying the first property of $\ll$ then states that there exists $d \in N(\upsilon_{n})$ such that $\{ \tau_{n+1} \} \ll \{ d \}$. The concatenation of $\langle \dots, \upsilon_{n+1} \rangle$ and $\langle d \rangle$, i.e. $\langle \dots, \upsilon_{n}, d \rangle$, forms a valid trajectory in $\Traj(N)$ and satisfies the properties $| \langle \dots, \tau_{n}, \tau_{n+1} \rangle | = | \langle \dots, \upsilon_{n}, d \rangle |$ and $\langle \dots, \tau_{n}, \tau_{n+1} \rangle \ll \langle \dots, \upsilon_{n}, d \rangle$. $\qedbox$

% We claim that, for all $\tau \in \Traj(M)$, there exists a $\upsilon \in \Traj(N)$, such that $| \tau | = | \upsilon |$ and $\tau \ll \upsilon$.

\subsection{Theorem~\ref{thm:lat-refines}}

First a lemma that shows $\lEq{\hat p \meet \lAntecedent(s)} \iff \lEq{\hat p} \meet \lAntecedent(s)$ is a reasonable assumption.

\begin{lemma}
$\sEq{D} = D \implies (\sEq{C \cap D} \iff \sEq{C} \cap D)$
\end{lemma}

That $x \in \sEq{C \cap D}$ can be stated as $\exists y : x \sim y \wedge y \in C \wedge y \in D$. That $y \in D$ implies that $x \in [D] = D$ since $x \sim y$, and we can therefore restate $x \in \sEq{C \cap D}$ as $\exists y : x \sim y \wedge y \in C \wedge x \in D \iff x \in \sEq{C} \wedge x \in D \iff x \in \sEq{C} \cap D$. $\qedbox$
\\

%% \begin{align*}
%% x \in \sEq{C \cap D} & \iff \exists y : x \sim y \wedge y \in C \wedge y \in D \\
%%                      & \iff \exists y : x \sim y \wedge y \in C \wedge x \in D \\
%%                      & \iff x \in \sEq{C} \wedge x \in D \\
%%                      & \iff x \in \sEq{C} \cap D
%% \end{align*}

Secondly, we show a few helpful lemmas that regard the fix-points and functions used to determine satisfaction with $\hat M$ and $\hat N$. To clarify which definitions are used with $\hat N$ and which are used with $\hat N$, we will duplicate some earlier definitions. Specifically, let $G$, $\mathcal{G}$ and $\Psi$ be equivalent operations for $\hat N$, as $F$, $\mathcal{F}$ and $\Phi$ are for $\hat M$:

\begin{align*}
G(s)(\hat q) &= \hat N(\lalpha(\pi_{a}(s)) \sqcap \hat q) \\
\mathcal{G}(\Psi)(s) &= \Stmt{if } (s = s_{0}) \Stmt{ then } \top \Stmt{ else } \sqcup \{ G(s')(\Psi(s')) \mid (s',s) \in R \} \\
\Psi_{n} &= \Stmt{if } (n = 0) \Stmt{ then } (\lambda s \in S : \bot) \Stmt{ else } \mathcal{G}(\Psi_{n-1}) \\
\end{align*}

\noindent Furthermore, let $\Psi_{*}$ be the least fixpoint of $\Psi = \mathcal{G}(\Psi)$ and given by $\lim \, \Psi_{n}(s)$.

\begin{lemma} \label{lem:bot-refine-bot}
$\bot \lll \bot$ \& $\top \lll \top$
\end{lemma}

A Galois connection always relates the two tops and bottoms, i.e. $\lalpha(\top) \ordered \top$ and $\lalpha(\bot) \ordered \bot$. Because $\lEq{\cdot}$ preserves both tops and bottoms, it follows that both $\lalpha(\lEq{\top}) \ordered \lEq{\top}$, or $\top \lll \top$, and $\lalpha(\lEq{\bot}) \ordered \lEq{\bot}$, or $\bot \lll \bot$, holds as well.

%% \begin{lemma} \label{lem:closed-join}
%% $\hat p \lll \hat q \wedge \hat r \lll \hat s \implies (\hat p \join \hat r) \lll (\hat q \join \hat s)$
%% \end{lemma}

%% Expanding $\lll$, we have $\hat \alpha(\lEq{\hat p}) \ordered \lEq{\hat q} \ordered \lEq{\hat q \join \hat s}$ and $\hat \alpha(\lEq{\hat r}) \ordered \lEq{\hat s} \ordered \lEq{\hat q \join \hat s}$ by the monotonicity of $\lEq{\cdot}$. Hence $\hat \alpha(\lEq{\hat p}) \join \hat \alpha(\lEq{\hat r}) = \hat \alpha(\lEq{\hat p \join \hat r}) \ordered \lEq{\hat q \join \hat s}$ as $\lEq{\cdot}$ and $\hat \alpha$ distribute over arbitrary union. \todo{Similarly}, $\hat \alpha(\hat M(\hat p)) \ordered \hat N(\hat q) \ordered \hat N(\hat q \join \hat s)$ and $\hat \alpha(\hat M(\hat r)) \ordered \hat N(\hat s) \ordered \hat N(\hat q \join \hat s)$. \todo{Thus} $\hat \alpha(\hat M(\hat p)) \join \hat \alpha(\hat M(\hat r)) = \hat \alpha(\hat M(\hat p) \join \hat M(\hat r)) \ordered \hat N(\hat q \join \hat s)$.

\begin{lemma} \label{lem:1}
$\hat p \lll \hat q \implies \forall s \in S : F(s)(\hat p) \lll G(s)(\hat q)$
\end{lemma}

\todo{Is the required step $\lgamma(\hat q) \rordered \hat p$ implied by $\hat p \lll \hat q$ or no?}

\begin{align*}
\lgamma(\lEq{G(s)(\hat q)})
  & =         \lgamma(\lEq{\hat N(\lAntecedent(s) \meet \hat q)}) \\
  & \rordered \lEq{\hat M(\lgamma(\lAntecedent(s) \meet \hat q))} \\
  & =         \lEq{\hat M(\lgamma(\lAntecedent(s)) \meet \lgamma(\hat q)))} \\
  & \rordered \lEq{\hat M(\lgamma(\lAntecedent(s)) \meet \hat p))} \\
  & =         \lEq{F(s)(\hat p)}
\end{align*}

\begin{lemma} \label{lem:3}
$\dots \implies \forall s \in S : \Phi_{*}(s) \lll \Psi_{*}(s)$
\end{lemma}

Since $\Phi_{*}(s) = \lim \, \Phi_{n}(s)$ and $\Psi_{*}(s) = \lim \, \Psi_{n}(s)$, it suffices to prove that $\Phi_{n}(s) \lll \Psi_{n}(s)$ for all $s \in S$ and $n \in \mathbb{N}$. We do so by induction on $n$. The base case, where $\Phi_{0}(s) = \bot$ and $\Psi_{0}(s) = \bot$, follows from lemma~\ref{lem:bot-refine-bot}. For the inductive step, assume that $\Phi_{n}(s) \lll \Psi_{n}(s)$ for all $s \in S$. For $s = s_{0}$, we have that $\Phi_{n+1}(s_{0}) = \top$ and $\Psi_{n+1}(s_{0}) = \top$, which also follows from lemma~\ref{lem:bot-refine-bot}. For any $s \neq s_{0}$, we have:

\begin{align*}
\lgamma(\lEq{\Psi_{n+1}})
  & =         \lgamma(\lEq{\mathcal{F}(\Psi_{n})(s)}) \\
  & =         \lgamma(\lEq{\join \{ F(s')(\Psi_{n}(s')) \mid (s',s) \in R \}}) \\
  & \rordered \dots
\end{align*}
\\

Consider an arbitrary $s \in S$ and let $\hat p = \Phi_{*}(s) \meet \lgamma(\lAntecedent(s))$, where $\hat p \ordered \Phi_{*}(s)$ and $\hat p \ordered \lgamma(\lAntecedent(s))$, or $\lalpha(\hat p) \ordered \lAntecedent(s)$. From lemma~\ref{lem:3} we know $\Phi_{*}(s) \lll \Psi_{*}(s)$, and thus $\lalpha(\hat p) \ordered \lalpha(\lEq{\hat p}) \ordered \lalpha(\lEq{\Phi_{*}(s)}) \ordered \lEq{\Psi_{*}(s)}$ by the monotonicity of $\lEq{\cdot}$ and $\lalpha$. Using the invariance of $\lAntecedent(s)$ and property \todo{name} of $\lEq{\cdot}$, we note that the assumption can be restated as $\lConsequent(s) \rordered \Psi_{*}(s) \meet \lAntecedent(s) = \lEq{\Psi_{*}(s) \meet \lAntecedent(s)} = \lEq{\Psi_{*}(s)} \meet \lAntecedent(s)$. It then follows that $\alpha(\hat p) \ordered \lConsequent(s)$, or $\hat p \ordered \lgamma(\lConsequent(s))$ as desired. $\qedbox$

\subsection{Theorem~\ref{thm:lat-imply-set}}

Text.
