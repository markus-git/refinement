\section{Refinement}

\subsection{Set-Theoretic refinement}

Consider another fixed, but arbitrary, circuit model $N \in \pow(\D) \rightarrow \pow(\D)$, where $\D$ is a non-empty and finite set of configurations. Further, let there be a Galois connection between predicates $\pow(\C)$ and $\pow(\D)$ ordered by set inclusion and given by means of a binary relation $\ll \, \subseteq \pow(\C) \times \pow(\D)$, where $C \ll D$ reads ``c can be approximated by d''. We define $\ll$ from either of the usual functions for abstraction $\alpha \in \pow(\C) \rightarrow \pow(\D)$ and concretisation $\gamma \in \pow(\D) \rightarrow \pow(\C)$:

\begin{equation*}
C \ll D \iff \alpha(C) \subseteq D \vsep C \ll D \iff C \subseteq \gamma(D)
\end{equation*}

\noindent Here $\subseteq$ on the $\alpha$-derivation side is the inclusion order of $\pow(\D)$, and on the $\gamma$-derivation side $\subseteq$ is the inclusion order of $\pow(\C)$. Intuitively, the relation $\ll$ acts as an extension of the orderings inside $\pow(\C)$ and $\pow(\D)$ to one between them. Note that $\{ \C \}$ and $\{ \D \}$ represent the ``unknown'' states where nothing is assumed, and we thus require that $\ll$ respects this property, i.e. $\{ \C \} = \gamma(\{ \D \})$.

Exactly what configurations such as $\C$ and $\D$ are, were not important previously. To reason about refinement, which relates the external behaviour of circuits, we make a distinction between the \textit{visible} and \textit{internal} elements of $\C$ and $\D$. Let $\sim \, \subseteq \C \times \C$ be an equivalence relation on $\C$; the equivalence class of any $c \in \C$ under $\sim$, denoted by $[c]$, is defined as $[c] = \{ c' \in \C | c' \sim c \}$ and identifies the class of configurations which are \textit{visually equivalent} to $c$. With a slight abuse of notation, we extend $[\cdot]$ to sequences component-wise and overload both $\sim$ and $[\cdot]$ to configurations in $\D$.

We can now formalize that $M$ \textit{refines} $N$, denoted by $M \Refines N$, as follows:

\begin{equation*}
\forall \tau \in \Traj(M) : \exists \upsilon \in \Traj(N) : | \tau | = | \upsilon | \wedge [\tau] \ll [\upsilon]
\end{equation*}

\noindent where $[\tau] \ll [\upsilon]$ iff $[\tau_{n}] \ll [\upsilon_{n}]$ for all $n \in \mathbb{N} : n < | \tau | = | \upsilon |$. In other words, $M \Refines N$ states that, for every sequence of configurations $\tau$ permitted by $M$, there must exist a sequence $\upsilon$ for $N$ which approximates the visual behaviour of $\tau$.

Recall that a trajectory assertion for $N$ is a quintuple $\TA = (S, s_{0}, R, \Antecedent, \Consequent)$, where $\Antecedent \in S \rightarrow \pow(\D)$ and $\Consequent \in S \rightarrow \pow(\D)$ label each $s \in S$ with its antecedents and consequents, respectively. If these antecedents and consequents accept partitions of visible elements in $\D$, i.e. $d \in \Antecedent(s) \iff [d] \subseteq \Antecedent(s)$ and $d \in \Consequent(s) \iff [d] \subseteq \Consequent(s)$ for all $s \in S$, then we refer to $\TA$ as a \textit{external trajectory assertion} and suffix it as $\ETA$. Furthermore, we define $\gamma(\TA) = (S, s_{0}, R, \gamma(\Antecedent), \gamma(\Consequent))$, where $\gamma(\Antecedent) = \lambda s \in S : \gamma(\Antecedent(s))$ and $\gamma(\Consequent) = \lambda s \in S : \gamma(\Consequent(s))$.

%% If the co-domain of $\Antecedent$ and $\Consequent$ is limited to partitions of visible elements in $D$, i.e. $\pow(D / \mkern-8mu\sim)$,

\begin{theorem} \label{thm:traj-refines}
$M \Refines N \implies (N \models \ETA \implies M \models \gamma(\ETA))$
\end{theorem}

The above definition of refinement can be equivalently formulated as a simulation relation. We say that $M$ refines $N$ by \textit{set-theoretic refinement}, denoted by $M \SetRefines N$, iff $\C$ is approximated by $\D$, i.e. $\{ \C \} \ll \{ \D \}$; $\ll$ is a \todo{explanation}, i.e. $C \ll D \implies \bigcup_{c \in C}[c] \ll \bigcup_{d \in D}[d]$; and $\ll$ is a \textit{simulation relation} from $\pow(\C)$ to $\pow(\D)$, i.e. $C \ll D \implies M(C) \ll N(D)$.

%% That $\ll$ is a \todo{explanation} and a simulation relation can also be stated in terms of the usual functions for abstraction $\alpha$ and concretisation $\gamma$.

\begin{theorem} \label{thm:traj-equal-set}
$M \Refines N \iff M \SetRefines N$
\end{theorem}
