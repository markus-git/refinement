\subsection{Refinement}

Consider another fixed, but arbitrary, circuit model $N \in \pow(\sD) \rightarrow \pow(\sD)$, where $\sD$ is a non-empty and finite set of configurations. Exactly what configurations such as $\sC$ and $\sD$ are, were not important previously. But to reason about refinement, which relates the external behaviour of circuits, we make a distinction between their elements. Let $\sim \, \subseteq \sC \times \sC$ be an equivalence relation on $\sC$. The equivalence class of a $c \in \sC$ under $\sim$, denoted by $[c]$, is defined as $[c] = \{ c' \in \sC | c' \sim c \}$. With a slight abuse of notation, we overload both $\sim$ and $[\cdot]$ to accept configurations in $\sD$. We also extend $[\cdot]$ to sets $C \subseteq \sC$ as $[C] = \cup\{[c] \in \pow(\sC) \mid c \in C \}$.

%% \todo{Example of how equiv. classes are predicates.}

\subsubsection{Refinement by trajectories} % Model correspondence

Let there be a Galois connection between \todo{predicates $\pow(\sC)$ and $\pow(\sD)$ ordered by set inclusion}. The usual definition of a Galois connection is in terms of an \textit{abstraction} $\alpha \in \pow(\sC) \rightarrow \pow(\sD)$ and a \textit{concretisation} $\gamma \in \pow(\sD) \rightarrow \pow(\sC)$ function, such that $\alpha(C) \subseteq D \iff C \subseteq \gamma(D)$ for all $C \in \pow(\sC)$ and $D \in \pow(\sD)$. \todo{For example, a Galois connection between \dots}

Furthermore, let the binary relation $\ll \, \subseteq \pow(\sC) \times \pow(\sD)$, where $C \ll D$ reads ``C can be approximated by D'', be derived from the above $\alpha$ or $\gamma$, such that:

\begin{equation*}
C \ll D \iff \alpha([C]) \subseteq [D] \vsep C \ll D \iff [C] \subseteq \gamma([D])
\end{equation*}

\noindent Here $\subseteq$ on the $\alpha$-derivation side is the inclusion order of $\pow(\sD)$, and on the $\gamma$-derivation side $\subseteq$ is the inclusion order of $\pow(\sC)$. Intuitively, $\ll$ acts as an extension of the orderings inside $\pow(\sC)$ and $\pow(\sD)$ to one \todo{between equivalence classes of them}. \todo{We require that $\alpha([c]) \neq \emptyset$ for all $c \in \sC$.} We extend $\ll$ to sequences component wise, such that $\tau \ll \upsilon$ iff $\{ \tau_{n} \} \ll \{ \upsilon_{n} \}$ for all $\tau \in \sC^{+}$, $\upsilon \in \sD^{+}$, and $n \in \mathbb{N} : n < | \tau | = | \upsilon |$.

%% Note that $\{ \C \}$ and $\{ \D \}$ represent the ``unknown'' states where nothing is assumed, and we thus require that $\ll$ respects this property, i.e. $\{ \C \} = \gamma(\{ \D \})$.

%% and identifies the class of configurations which are \textit{visually equivalent} to $c$.

We can now formalize that $M$ \textit{refines} $N$, denoted by $M \Refines N$, as follows:

\begin{equation*}
\forall \tau \in \Traj(M) : \exists \upsilon \in \Traj(N) : | \tau | = | \upsilon | \wedge \tau \ll \upsilon
\end{equation*}

\noindent In other words, for every sequence of configurations $\tau$ permitted by $M$, there must exist a sequence $\upsilon$ for $N$ which approximates the behaviour of $\tau$ according to \todo{their equivalence relations}. \todo{Example.}

\subsubsection{Refinement \& assertions}

\todo{Recall that} a trajectory assertion for $N$ is a quintuple $A = (S, s_{0}, R, \Antecedent, \Consequent)$, where $\Antecedent \in S \rightarrow \pow(\sD)$ and $\Consequent \in S \rightarrow \pow(\sD)$ label each $s \in S$ with its antecedents and consequents, respectively. If $\Antecedent$ and $\Consequent$ are class invariant under $\sim$, i.e. $d \in \Antecedent(s) \iff [d] \subseteq \Antecedent(s)$ for all $s \in S$ and \todo{similarly for $\Consequent$}, then we refer to $A$ as an \textit{\todo{name} trajectory assertion} and suffix it as $A_{\todo{n}}$. Furthermore, we define $\gamma(A) = (S, s_{0}, R, \gamma(\Antecedent), \gamma(\Consequent))$, where $\gamma(\Antecedent) = \lambda s \in S : \gamma(\Antecedent(s))$ and $\gamma(\Consequent) = \lambda s \in S : \gamma(\Consequent(s))$. \todo{We require that $\gamma$ preserves the invariance of $\Antecedent$ and $\Consequent$, i.e. $c \in \gamma(\Antecedent(s)) \iff [c] \subseteq \gamma(\Antecedent(s))$ and similarily for $\Consequent$.}

%% $d \in \Consequent(s) \iff [d] \subseteq \Consequent(s)$

%% If the co-domain of $\Antecedent$ and $\Consequent$ is limited to partitions of visible elements in $D$, i.e. $\pow(D / \mkern-8mu\sim)$,

We are now ready to state that, if $M$ refines $N$ and $A_{\todo{n}}$ is satisfied in $N$, then a concretisation of $A_{\todo{n}}$ can also be satisfied in $M$:

\begin{theorem} \label{thm:traj-refines}
$M \Refines N \implies (N \models A_{\todo{n}} \implies M \models \gamma(A_{\todo{n}}))$
\end{theorem}

%% \subsubsection{Refinement by simulation}

Refinement can be equivalently formulated as $\ll$ being a simulation relation. More specifically, we say that $M$ refines $N$ by \textit{set-theoretic simulation}, denoted by $M \sRefines N$, iff (1) $\ll$ is a \todo{name}, i.e. $C \ll D \implies \forall c \in C: \exists d \in D: \{ c \} \ll \{ d \}$; and (2) $\ll$ is a \textit{simulation relation} from $\pow(\sC)$ to $\pow(\sD)$, i.e. $C \ll D \implies M(C) \ll N(D)$.

% (1) $\ll$ is a \todo{name}, i.e. \todo{$C \ll D \implies \cup \{ [c] \in \pow(\sC) \mid c \in C \} \ll \cup \{ [d] \in \pow(\sD) \mid d \in D \}$}; and (2) 

%% \todo{A Galois connection always relates the top and bottom values, i.e. $\{ \sC \} \ll \{ \sD \}$ and $\{ \emptyset \} \ll \{ \emptyset \}$.}

%% That $\ll$ is a \todo{explanation} and a simulation relation can also be stated in terms of the usual functions for abstraction $\alpha$ and concretisation $\gamma$.

\begin{theorem} \label{thm:traj-equal-set}
$M \Refines N \iff M \sRefines N$
\end{theorem}

\noindent \todo{Text.}
