\section{Refinement}

\subsection{Set-Theoretic refinement}

Consider another fixed, but arbitrary, circuit model $N \in \Pow(D) \rightarrow \Pow(D)$, where $D$ is a non-empty and finite set of configurations. In order to relate $D$ to the previous $C$, let there be a Galois connection $\ll \, \subseteq \Pow(C) \times \Pow(D)$ given by means of a binary relation between $\Pow(P)$ and $\Pow(Q)$ ordered by set inclusion $\subseteq$. The relation $\ll$ acts as an extension of the orderings inside $\Pow(C)$ and $\Pow(D)$ to one between them, such that configurations in any $P \subseteq \Pow(C)$ and $Q \subseteq \Pow(D)$ are related iff their union and intersection are related:

\begin{equation*}
P \ll Q \iff \forall p \in P : \forall q \in Q : p \ll q \iff \cup P \ll \cap Q
\end{equation*}

\noindent where $p \ll q$ reads as ``$p$ approximates $q$''. The usual functions for abstraction $\alpha \in \Pow(C) \rightarrow \Pow(D)$ and concretisation $\gamma \in \Pow(D) \rightarrow \Pow(C)$ can be derived from $\ll$ as follows: $\alpha(c) = \cap \{ d \in \Pow(D) \mid c \ll d \}$ and $\gamma(d) = \cup \{ c \in \Pow(C) \mid c \ll d \}$. Conversely, the relation $\ll$ can be derived from $\alpha$ or $\gamma$ as: $c \ll d \iff \alpha(c) \subseteq d$ or $c \ll d \iff c \subseteq \gamma(d)$. \todo{Note properties of $\alpha$ and $\gamma$?}

Exactly what configurations such as $C$ and $D$ are, were not important previously. To reason about refinement, which relates the visible behaviour of circuits, we make a distinction between their external and internal elements. Let the visible elements of a configuration in $C$ be identified by two predicates, $\In \in C \rightarrow \Pow(C)$ and $\Out \in C \rightarrow \Pow(C)$, where $\In(c)$ denotes the configurations with \textit{inputs} equal to a $c \in C$, and $\Out(c)$ denotes configurations with equal \textit{outputs}. Further, let $\In(\cdot)$ and $\Out(\cdot)$ induce equivalence relations $\InSim$ and $\OutSim$ on configurations in $C$, respectively, such that $c \InSim c' \iff \In(c) = \In(c')$ and $c \OutSim c' \iff \Out(c) = \Out(c')$. With a slight abuse of notation, we overload $\In(\cdot)$ and $\Out(\cdot)$ to accept configurations in $D$ as well.

We now formalize an intuition of whether $M$ \textit{refines} $N$, denoted by $M \Refines N$:

\begin{equation*}
\forall \tau \in \Traj(M) : \exists \upsilon \in \Traj(N) : | \tau | = | \upsilon | \wedge \tau \ll_{\In} \upsilon \wedge \tau \ll_{\Out} \upsilon
\end{equation*}

\noindent where $\langle \tau_{0}, \ldots \rangle \ll_{\In} \langle \upsilon_{0}, \ldots \rangle$ iff $\In(\tau_{n}) \ll \In(\upsilon_{n})$ for all $n \in \mathbb{N} : n < | \tau | = | \upsilon |$; $\tau \ll_{\Out} \upsilon$ is similarly defined by $\Out(\cdot)$. Intuitively, $M \Refines N$ states that, for every sequence of configurations $\tau$ permitted by $M$, there must exist a sequence $\upsilon$ for $N$ which approximates the input-output behaviour of $\tau$. That is, $N$ must ``cover'' the input-output behaviour of $M$.

\todo{While refinement talks about input behaviours for $M$ and $N$, we should recall that models generally cannot control their inputs, and leave such signals unconstrained for every transition. A trajectory $\tau \in \Traj(M)$ is thus \textit{driven} by an implicit choice of inputs.} Let $I = \Traj(M) / \mkern-5mu\InSim$ be the partition of all trajectories in $M$ with respect to $\InSim$. \todo{Text.}

% Let $\Traj(M)(\delta)$ be the equivalence class of trajectories under a common \textit{driver} $\delta \in \In[C]^{+}$, defined as $\Traj(M)(\delta) = \{ \tau \in \Traj(M) \mid \forall n \in \mathbb{N} : n < | \delta| \implies \In(\tau_{n}) = \delta_{n} \}$.

\begin{equation*}
\forall \delta \in \In[C]^{+} : \forall \tau \in \Traj(M)(\delta) : \exists \upsilon \in \Traj(N)(\delta) : \tau \ll_{\Out} \upsilon
\end{equation*}

\noindent \todo{Not sure this, or something like it, is needed/helps anymore.}

% \todo{Refinement can be equivalently expressed as a simulation relation.}

% \todo{$M$ \textit{refines} the circuit $N$ by \textit{set-theoretic visual refinement}, denoted by $M \SetRefines N$, iff $C \ll D$ and the Galois connection $\ll$ is \textit{simulation relation}, such that $c \ll d$ implies $\Out[c] \ll \Out[d]$ and $M(c \cap \{ i \}) \ll N(d \cap \{ i \})$ for all $i \in \In[C]$.}

A Galois connection $ll$ is a \textit{visual simulation relation} between $M$ and $N$ iff $c \ll d$ implies $\Out[c] \subseteq \gamma(\Out[d])$ and $\ldots$.

$M$ refines $N$ by \textit{set-theoretic refinement} iff $C \ll D$ and $\ll$ is a visual simulation relation.

