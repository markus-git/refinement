\section{Refinement}

\subsection{Set-Theoretic refinement}

Consider another fixed, but arbitrary, circuit model $N \in \pow(D) \rightarrow \pow(D)$, where $D$ is a non-empty and finite set of configurations which intersects the earlier set $C$. Exactly what configurations such as $C$ and $D$ are, were not important previously. To reason about refinement, however, we need to make a distinction between their external and internal elements. The rationale is that refinement relates the visible behaviour of circuits. \todo{Unnecessary to assume that internal states can be related.}

% ... intersects the earlier set C, i.e. we assume $C \cap D \neq \emptyset$.
% ... internal states is of no real significance if their external behaviours match.
% ... Restricting refinement to models where internal states can be aligned thus seems unnecessary.

Let the visible components visible elements of configurations in $D$ be identified by two projection mappings, $\Out \in \pow(D) \rightarrow \pow(D)$ and $\In \in \pow(D) \rightarrow \pow(D)$, identifying its ``inputs'' and ``outputs'', respectively. The set of all possible inputs in $N$ is given by the image $\In[\pow(D)] = \{ \In(p) \mid p \in \pow(D) \}$ and denoted by $I$. Outputs in $N$ are similarily given by the image $\Out[\pow(D)]$ and denoted by $O$. Note that, since models generally cannot control their input signals, transitions in $N$ from a state $d \in \pow(D)$ are driven by its intersection with a chosen input $i \in I$, \todo{that is, $N(d \cap i)$ yeilds the next state of $d$ for input $i$.}

A \textit{trajectory} of $N$ is a non-empty sequence of configurations, $\tau \in D^{+}$, derived from the states generated by $N$ in response to a \textit{driver} $\delta \in I^{+}$ when started in its most general state. Specifically, the trajectory $\tau$ induced by a $\delta$ is defined such that $\tau_{0} = D$ and $\tau_{n+1} = N(\tau_{n} \cap \delta_{n})$ for all $n \in \mathbb{N} : n < | \delta |$. \todo{We denote the trajectory of $N$ induced by a $\delta$ by $N_{\delta}$ and note that it is prefix-closed.} \todo{The set of all possible drivers, and the trajectories they induce, describes every behaviour of $N$ for the arbitrary initial state.}

% ... Because $D$ is finite, we also see that the set of all possible trajectories of $N$ captures every behaviour for starting in the arbitrary initial state.

With a slight abuse of notation, we extend $\Out(\cdot)$ to sequences component-wise and overload it to accept configurations $D$. \todo{Furthermore}, we assume that both inputs and outputs of $M$ are contained by $N$, i.e. $\In[\pow(C)] \subseteq \In[\pow(D)]$ and $\Out[\pow(C)] \subseteq \Out[\pow(D)]$. \todo{Finally}, we say the circuit $M$ refines the circuit $N$, denoted by $M \srefine N$, iff:

\begin{equation*}
\forall \delta \in I^{+} : \Out(M_{\delta}) \subseteq \Out(N_{\delta})
\end{equation*}

Text.

\begin{theorem}
\label{thm:refinement}
If $M$ and $N$ are ciruit models such that $M \srefine N$, and $A_{vis}$ is a visible trajectory assertion for $N$, then:

\begin{equation*}
N \smodels \, A_{vis} \implies M \smodels \, \alpha(A_{vis})
\end{equation*}
\end{theorem}

\noindent Text.

\subsection{Lattice-Theoretic refinement}

Let $\hat N \in \hat Q \rightarrow \hat Q$ be an abstract interpretation of $N$, where $\hat Q$ is an abstract predicate for which there is a Galois connection to $\pow(D)$.

Let the output of an abstract predicate $\hat Q$ be identified by the idempotent mapping $\Outt \in \hat Q \rightarrow \hat Q$, such that $\Outt(\cdot)$ is monotonic, i.e. $\hat p \sqsubseteq \hat q \implies \Outt(\hat p) \sqsubseteq \Outt(\hat q)$; and the greatest bound for an output, i.e. $\Outt(\hat p) \sqsubseteq \Outt(\hat q) \iff \hat p \sqsubseteq \Outt(\hat q)$. \todo{In a similar vein, let the inputs of an abstract predicate $\hat Q$ be identified by the mapping $\Inn \in \hat Q \rightarrow \hat Q$.}

% As before, we overload $\Outt(\cdot)$ to accept predicates from $\hat Q$

% The sets of all possible inputs and outputs for $\hat P$ are defined as $\In(\hat P) = \{ \In(\hat p) \mid \hat p \in \hat P \}$ and $\Out(\hat P) = \{ \Out(\hat p) \mid \hat p \in \hat P \}$. 

In the case of an unit-delayed AND gate and its predicates $\langle p_{0}, p_{1}, p_{2} \rangle \in \mathbb{T}_{\bot}^{3}$, for example, $\Inn(\cdot)$ and $\Outt(\cdot)$ can be defined naturally as projections which maps each non-input and non-output element to $\X$, respectively:

\begin{equation*}
\begin{aligned}[t]
\Inn(\langle \hat p_{0}, \hat p_{1}, \hat p_{2} \rangle) &= \langle \hat p_{0}, \hat p_{1}, \X \rangle \\
\Inn(\bot) &= \bot
\end{aligned}
\qquad
\begin{aligned}[t]
\Outt(\langle \hat p_{0}, \hat p_{1}, \hat p_{2} \rangle) &= \langle \X, \X, p_{2} \rangle \\
\Outt(\bot) &= \bot
\end{aligned}
\end{equation*}

\noindent It is easy to see that $\Outt(\cdot)$ is monotonic, and that it produces the greatest bound for any $\mathbb{T}^{3}$ with an output $\sqsubseteq \hat p_{2}$.

%% We adopt a different interpretation of Galois connections that is given by means of a binary relation between $\pow(C)$ and $\hat P$. Specifically, let $\ll \, \subseteq \pow(C) \times \hat P$ be a binary relation, where $p \ll \hat p$ reads as ``$p$ can be approximated as $\hat p$'', such that for all $Q \subseteq \pow(C)$ and $\hat Q \subseteq \hat P$:

%% \begin{equation*}
%% \forall p \in Q : \forall \hat p \in \hat Q : p \ll \hat p \iff \cup Q \ll \sqcap \hat Q
%% \end{equation*}

%% \noindent Intuitively, this relation is an extension of the partial order $\subseteq$ of $\pow(C)$ and $\sqsubseteq$ of $\hat P$ to an ordering between $\pow(C)$ and $\hat P$. The original abstraction and concretisation functions can be derived from the relation by: $\alpha(p) = \sqcap \{ \hat p \in \hat P \mid p \ll \hat p \}$ and $\gamma(\hat p) = \cup \{ p \in \pow(C) \mid p \ll \hat p \}$. Conversely, the relation can be derived from $\alpha$ and $\gamma$ as: $p \ll \hat p \iff \alpha(p) \sqsubseteq \hat p$ and $p \ll \hat p \iff p \subseteq \gamma(\hat p)$.

Let $\cc \, \subseteq \hat P \times \hat Q$ be a Galois connection, such that elements of subsets $\hat P^{*} \subseteq \hat P$ and $\hat Q^{*} \subseteq \hat Q$ are related iff their join and meet are related:

\begin{equation*}
\forall \hat p \in \hat P^{*} : \forall \hat q \in \hat Q^{*} : \hat p \cc \hat q \iff \sqcup \hat P^{*} \cc \sqcap \hat Q^{*}
\end{equation*}

\noindent where $\hat p \cc \hat q$ reads as ``$\hat p$ refines $\hat q$''. Like the earlier Galois connection, this relation can also be thought of as an extension of the orderings inside $\hat P$ and $\hat Q$ to an ordering between them. The usual abstraction $\alpha \in \hat P \rightarrow \hat Q$ and concretisation $\gamma \in \hat Q \rightarrow \hat P$ functions can be derived from $\cc$ as follows:

\begin{align*}
\alpha(p) = \sqcap \{ \hat p \in \hat P \mid \hat q \cc \hat p \} && \gamma(\hat p) = \sqcup \{ \hat q \in \hat Q \mid \hat q \cc \hat p \}
\end{align*}

\noindent We note that $\gamma$ is monotone, preserves top and distributes over arbitrary meet, i.e. $\gamma(\sqcap \hat Q) = \sqcap \{ \gamma(\hat q) \in \hat P \mid \hat q \in \hat Q\}$. Similarly, $\alpha$ is monotone, preserves bottom and distributes over arbitrary join.

We say that a relation $\cc \, \subseteq \hat P \times \hat Q$ is a \textit{visible simulation relation} between $\hat M$ and $\hat N$ iff the top of $\hat P$ refines the top of $\hat Q$, i.e. $(\top \in \hat P) \cc \, (\top \in \hat Q)$, and $\hat p \cc \hat q$ implies (1) $\Outt(\hat p) \sqsubseteq \gamma(\Outt(\hat q))$ and (2) $\hat M(\hat \iota \sqcap \hat p) \cc \hat N(\alpha(\hat \iota) \sqcap \hat q)$ for all inputs $\hat \iota \in \Inn(\hat P)$.

Recall that a trajectory assertion for $\hat N$ is a quintuple $\hat A = (S, s_{0}, R, \pi_{a}, \pi_{c})$, where $\pi_{a} \in S \rightarrow \hat Q$ and $\pi_{c} \in S \rightarrow \hat Q$ label each state $s \in S$ with an antecedent $\pi_{a}(s)$ and a consequent $\pi_{c}(s)$. If these antecedents only mention inputs, i.e. $\pi_{a} \in S \rightarrow \Inn(\hat P)$, and consequents only mention outputs, i.e. $\pi_{c} \in S \rightarrow \Outt(\hat P)$, then $\hat A$ is referred to as a \textit{visible trajectory assertion} for $\hat N$, which we denote by $\hat A_{vis}$. Define $\alpha(\hat A) = (S, s_{0}, R, \alpha(\pi_{a}), \alpha(\pi_{c}))$, where $\alpha(\pi_{a}) = \lambda s \in S : \alpha(\pi_{a}(s))$ and $\alpha(\pi_{a}) = \lambda s \in S : \alpha(\pi_{a}(s))$. Note that, if $\hat A_{vis}$ is an assertion for $\hat N$, then $\alpha(\hat A_{vis})$ is an assertion for $\hat M$.

\begin{theorem}
\label{thm:refinement}
If $\hat M$ and $\hat N$ are abstract predicate transformers such that $\hat M \cc \hat N$, and $\hat A_{vis}$ is a visible trajectory assertion for $\hat N$, then:

\begin{equation*}
\hat N \models \hat A_{vis} \implies \hat M \models \alpha(\hat A_{vis})
\end{equation*}
\end{theorem}
